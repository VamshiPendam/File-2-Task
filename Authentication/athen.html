<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>File2Task Auth Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Identity Services SDK -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, #43b6ea 0%, #18e5df 100%);
        font-family: "Segoe UI", Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        box-sizing: border-box;
      }

      .form-group {
        position: relative;
        min-height: 65px; /* Adjust based on field and error height */
      }
      .error-msg {
        position: absolute;
        left: 0;
        bottom: 2px;
        width: 100%;
        min-height: 18px;
        height: auto;
        font-size: 0.98rem;
        color: #ff3141;
        font-weight: 600;
        text-align: left;
        pointer-events: none;
      }

      .auth-container {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: flex-start;
        width: 1200px;
        max-width: 98vw;
        min-width: 320px;
        box-sizing: border-box;
        padding: 35px 0;
        gap: 0;
      }
      .form-panel {
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 6px 32px rgba(73, 161, 255, 0.13);
        padding: 36px 32px 22px 32px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 600px;
        max-height: 90vh;
        width: 33.33%;
      }
      .signup-panel {
        margin-right: 12px;
      }
      .center-panel {
        margin: 0 12px;
      }
      .login-panel {
        margin-left: 12px;
      }
      .form-panel h2 {
        text-align: center;
        margin-bottom: 10px;
        font-size: 2rem;
        font-weight: bold;
        letter-spacing: 2px;
      }
      .form-panel p {
        text-align: center;
        color: #6f767a;
        font-size: 1.08rem;
        margin-bottom: 13px;
      }
      .logo-circle {
        background: #090909;
        border-radius: 50%;
        margin-bottom: 18px;
        width: 110px;
        height: 110px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(81, 199, 246, 0.13);
      }
      .logo-circle img {
        width: 110px;
        height: 110px;
        object-fit: contain;
        border-radius: 50%;
      }
      .center-txt {
        color: #222;
        font-size: 1.07rem;
        text-align: center;
        margin-bottom: 18px;
        margin-top: 4px;
      }
      .google-btn {
        display: flex;
        align-items: center;
        gap: 13px;
        background: #fff;
        padding: 13px 38px;
        border-radius: 10px;
        box-shadow: 0 3px 12px rgba(41, 178, 206, 0.08);
        color: #222;
        font-weight: 600;
        font-size: 1.13rem;
        border: none;
        cursor: pointer;
      }
      .google-btn img {
        width: 27px;
        height: 27px;
      }
      .form-row {
        display: flex;
        gap: 16px;
        width: 100%;
        margin-bottom: 18px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        width: 100%;
        min-width: 120px;
      }
      .form-group label {
        font-weight: 600;
        color: #20272a;
        margin-bottom: 7px;
        font-size: 1rem;
      }
      .form-group input,
      .form-group select {
        border: 1px solid #e2e6ea;
        border-radius: 8px;
        padding: 11px 14px;
        font-size: 1.06rem;
        margin-bottom: 0px;
        background: #f6f7fa;
        font-family: inherit;
        outline: none;
        transition: border 0.16s, background 0.18s;
        box-sizing: border-box;
        width: 100%;
        min-width: 0;
      }
      .form-group input:focus,
      .form-group select:focus {
        border-color: #43b6ea;
      }
      .submit-btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(90deg, #43b6ea 0%, #18e5df 100%);
        color: #fff;
        font-weight: 700;
        font-size: 1.18rem;
        margin: 16px 0 0 0;
        cursor: pointer;
        transition: background 0.18s;
      }
      .log-btn {
        width: 100%;
        padding: 14px;
        background: #e2e6ea;
        border: none;
        font-weight: bold;
        font-size: 1.09rem;
        color: #333;
        border-radius: 8px;
        margin-top: 10px;
        cursor: pointer;
      }
      .form-panel .small-link {
        text-align: center;
        color: #9e9e9e;
        margin-top: 13px;
        font-weight: 500;
        font-size: 0.97rem;
      }
      .error-msg {
        color: #ff3141;
        font-size: 0.98rem;
        margin-top: 2px;
        font-weight: 600;
        text-align: left;
      }
      .invalid {
        border-color: #ff3141 !important;
        background: #ffe6e4 !important;
      }
      .valid {
        border-color: #43b6ea !important;
      }
      @media (max-width: 1100px) {
        .auth-container {
          flex-direction: column;
          width: 96vw;
        }
        .signup-panel,
        .center-panel,
        .login-panel {
          width: 99vw;
          min-width: 220px;
          max-width: 430px;
        }
        .form-panel {
          min-height: auto;
        }
      }
      @media (max-width: 650px) {
        .form-panel,
        .center-panel {
          padding-left: 6vw;
          padding-right: 6vw;
        }
        .form-row {
          flex-direction: column;
          gap: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <!-- Sign Up Panel -->
      <div class="form-panel signup-panel">
        <h2>Sign Up</h2>
        <p>Fill in the details to create your account</p>
        <form id="signupForm" novalidate>
          <div class="form-row">
            <div class="form-group">
              <label>Full Name</label>
              <input
                type="text"
                id="signupName"
                placeholder="Enter your full name"
              />
              <div class="error-msg" id="errorName"></div>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input
                type="email"
                id="signupEmail"
                placeholder="Enter your email"
              />
              <div class="error-msg" id="errorEmail"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Gender</label>
              <select id="signupGender">
                <option value="">Select Gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
              <div class="error-msg" id="errorGender"></div>
            </div>
            <div class="form-group">
              <label>Standard</label>
              <select id="signupStandard">
                <option value="">Select Standard</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
                <option>Btech</option>
                <option>other</option>
              </select>
              <div class="error-msg" id="errorStandard"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Password</label>
              <input
                type="password"
                id="signupPassword"
                placeholder="Enter password"
              />
              <div class="error-msg" id="errorPassword"></div>
            </div>
            <div class="form-group">
              <label>Confirm Password</label>
              <input
                type="password"
                id="signupConfirm"
                placeholder="Confirm password"
              />
              <div class="error-msg" id="errorConfirm"></div>
            </div>
          </div>
          <button type="submit" class="submit-btn">Submit</button>
        </form>
      </div>

      <!-- Center Panel with Google Buttons -->
      <div class="form-panel center-panel">
        <div class="logo-circle">
          <img src="/Images/Logo.jpg" alt="File2Task Logo" />
        </div>
        <div class="center-txt"> sign up or log in with</div>
        <!-- Google Identity SDK Integration -->
        <div
          id="g_id_onload"
          data-client_id="191261934491-l3rrbrl8cqljj6cmvikfmie1il2frbh4.apps.googleusercontent.com"
          data-context="signin"
          data-ux_mode="popup"
          data-callback="handleGoogleLogin"
        ></div>
        <div
          class="g_id_signin"
          data-type="standard"
          data-shape="rectangular"
          data-theme="outline"
          data-text="signup_with"
          data-size="large"
          style="margin-bottom: 14px"
        ></div>
        <div
          class="g_id_signin"
          data-type="standard"
          data-shape="rectangular"
          data-theme="outline"
          data-text="signin_with"
          data-size="large"
        ></div>
      </div>

      <!-- Log In Panel -->
      <div class="form-panel login-panel">
        <h2>Log In</h2>
        <p>Enter your credentials to access your account</p>
        <form id="loginForm" novalidate>
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="loginEmail"
              placeholder="Enter your email"
            />
            <div class="error-msg" id="loginErrorEmail"></div>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="loginPassword"
              placeholder="Enter password"
            />
            <div class="error-msg" id="loginErrorPassword"></div>
          </div>
          <button type="submit" class="submit-btn">Log In</button>
        </form>
      </div>
    </div>

    <script>
      // Simple UI validation helper
      function setError(elem, msg, valid) {
        elem.classList.remove("valid", "invalid");
        if (msg) {
          elem.classList.add("invalid");
        } else if (valid) {
          elem.classList.add("valid");
        }
      }

      // API helpers
      async function apiCall(endpoint, data) {
        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'API call failed');
          }
          return await response.json();
        } catch (err) {
          console.error('API error:', err);
          throw err;
        }
      }

      // Utility: base64url decode for JWT payload
      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

      // Signup handler
      document.getElementById("signupForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const name = document.getElementById("signupName");
        const email = document.getElementById("signupEmail");
        const gender = document.getElementById("signupGender");
        const standard = document.getElementById("signupStandard");
        const pwd = document.getElementById("signupPassword");
        const conf = document.getElementById("signupConfirm");

        let errors = 0;
        const nameVal = name.value.trim();
        if (!nameVal || nameVal.length < 3 || !/^[A-Za-z\s]+$/.test(nameVal)) {
          document.getElementById("errorName").textContent = "Enter a valid name (min 3 letters).";
          setError(name, true);
          errors++;
        } else {
          document.getElementById("errorName").textContent = "";
          setError(name, false, true);
        }
        const emailVal = email.value.trim().toLowerCase();
        const emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailVal || !emailReg.test(emailVal)) {
          document.getElementById("errorEmail").textContent = "Enter a valid email.";
          setError(email, true);
          errors++;
        } else {
          document.getElementById("errorEmail").textContent = "";
          setError(email, false, true);
        }
        if (!gender.value) {
          document.getElementById("errorGender").textContent = "Select gender.";
          setError(gender, true);
          errors++;
        } else {
          document.getElementById("errorGender").textContent = "";
          setError(gender, false, true);
        }
        if (!standard.value) {
          document.getElementById("errorStandard").textContent = "Select standard.";
          setError(standard, true);
          errors++;
        } else {
          document.getElementById("errorStandard").textContent = "";
          setError(standard, false, true);
        }
        const pwdVal = pwd.value;
        const pwdCheck = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\w\s]).{8,}$/;
        if (!pwdVal || !pwdCheck.test(pwdVal)) {
          document.getElementById("errorPassword").textContent = "Password must be 8+ chars, upper & lower case, digit & symbol.";
          setError(pwd, true);
          errors++;
        } else {
          document.getElementById("errorPassword").textContent = "";
          setError(pwd, false, true);
        }
        const confVal = conf.value;
        if (confVal !== pwdVal || !confVal) {
          document.getElementById("errorConfirm").textContent = "Passwords do not match.";
          setError(conf, true);
          errors++;
        } else {
          document.getElementById("errorConfirm").textContent = "";
          setError(conf, false, true);
        }

        if (errors === 0) {
          try {
            const response = await apiCall('/register', {
              name: nameVal,
              email: emailVal,
              gender: gender.value,
              standard: standard.value,
              password: pwdVal
            });

            // Registration succeeded; do NOT redirect. Prompt user to log in.
            alert("Registration successful. Please log in to continue.");
            // Prefill login email and focus password field for convenience
            document.getElementById('loginEmail').value = emailVal;
            document.getElementById('loginPassword').focus();
            e.target.reset();
          } catch (err) {
            console.error("Signup error:", err);
            if (err.message.includes('exists') || err.message.includes('409')) {
              alert("An account with this email already exists. Please log in.");
            } else {
              alert("Registration failed: " + err.message);
            }
          }
        }
      });

      // Login handler
      document.getElementById("loginForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const email = document.getElementById("loginEmail");
        const pwd = document.getElementById("loginPassword");
        let errors = 0;
        const emailVal = email.value.trim().toLowerCase();
        const emailReg = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailVal || !emailReg.test(emailVal)) {
          document.getElementById("loginErrorEmail").textContent = "Enter a valid email.";
          setError(email, true);
          errors++;
        } else {
          document.getElementById("loginErrorEmail").textContent = "";
          setError(email, false, true);
        }
        if (!pwd.value || pwd.value.length < 6) {
          document.getElementById("loginErrorPassword").textContent = "Password required (min 6 chars).";
          setError(pwd, true);
          errors++;
        } else {
          document.getElementById("loginErrorPassword").textContent = "";
          setError(pwd, false, true);
        }
        if (errors === 0) {
          try {
            const response = await apiCall('/login', {
              email: emailVal,
              password: pwd.value
            });
            
            // Store JWT token, name, and email in localStorage
            localStorage.setItem('token', response.token);
            localStorage.setItem('userName', response.name || emailVal.split('@')[0]);
            localStorage.setItem('userEmail', emailVal);
            localStorage.setItem('isGoogleUser', 'false');
            
            console.log("Login successful");
            alert("Log In successful â€” redirecting...");
            e.target.reset();
            window.location.href = "../LandingPages/index.html";
          } catch (err) {
            console.error("Login error:", err);
            if (err.message.includes('not found')) {
              alert("No account found. Please sign up first.");
            } else if (err.message.includes('password')) {
              alert("Incorrect password.");
            } else if (err.message.includes('Google Sign-In')) {
              alert("Please use the Google Sign-In button for this account.");
            } else {
              alert("Login failed: " + err.message);
            }
          }
        }
      });

      // Google Identity callback: receives response with credential (JWT)
      async function handleGoogleLogin(response) {
        const credential = response && response.credential;
        if (!credential) {
          console.warn("Google response missing credential", response);
          alert("Google Sign-In failed: No credential received");
          return;
        }
        
        try {
          // Parse JWT to extract user info
          const decoded = parseJwt(credential);
          if (!decoded) {
            throw new Error("Could not parse JWT");
          }
          
          const userName = decoded.name || decoded.email || 'User';
          const userEmail = decoded.email || '';
          
          // Store user info in localStorage directly (no backend verification)
          localStorage.setItem('token', credential); // store JWT as token
          localStorage.setItem('userName', userName);
          localStorage.setItem('userEmail', userEmail);
          localStorage.setItem('isGoogleUser', 'true');
          
          console.log('Google Sign-In successful:', userName, userEmail);
          
          // Redirect to landing page
          window.location.href = "../LandingPages/index.html";
        } catch (err) {
          console.error("Google Sign-In error:", err);
          alert("Google Sign-In failed: " + err.message);
        }
      }

      // Local testing button: simulate google sign-in by prompting email
      document.getElementById("testGoogleBtn").addEventListener("click", function () {
        const em = prompt("Enter test Google email:");
        if (!em) return;
        // simulate a Google payload-like object
        const fakePayload = { email: em.trim().toLowerCase(), name: em.split("@")[0] };
        // if you want to reuse the same handle, craft a fake JWT wrapper
        handleGoogleLogin({ credential: "fake." + btoa(JSON.stringify(fakePayload)) + ".sig" });
      });
    </script>
  </body>
</html>
